\section{Driving controller}

The driving controller must control the angular velocity of the motors using feedback from the \gls{dgps}. To simplify the calculations revolving the modelling of the lawn mower, the vehicle be modelled as having two wheels instead of crawler treads.
\autoref{fig:motor_calc2} shows the two wheels of the vehicle, placed in a coordinate system.

\begin{figure}[h]
\centering
\includegraphics[width=0.6\textwidth]{motor2}
\caption{Vehicle to be turned towards reference point $x_{ref}$.}
\label{fig:motor_calc2}
\end{figure}

The center point of the vehicle is the current position received from the \gls{dgps}. The direction of the vehicle is determined as seen in \autoref{eq:directionvect}.

\begin{equation}
\vec{F} = \vec{x_c} - \vec{x_{c,prev}}  \addunit{}
\end{equation}
\startexplain
	\explain{$\vec{F}$ is the direction of the vehicle}{}
	\explain{$x_{c}$ is the center point of the vehicle}{}
	\explain{$x_{c,prev}$ is the previous position}{}
	\label{eq:directionvect}
\stopexplain

To get the vehicle rotated to follow the vector $\vec{V_T}$, a reference point $x_{ref}$ must be calculated, to determine whether there is an angle between the direction vector $\vec{F}$ and the reference vector $\vec{V_{ref}}$.
The reference point $x_{ref}$ is determined as a predefined distance from $x_{ort}$, which is a orthogonal point from the center point of the vehicle, and determined as:

\begin{equation}
x_{ort} = \frac{\vec{V_T}\bullet (x_c - x_0)}{|\vec{V_T}|^2} \cdot \vec{V_T} + x_0 \addunit{}
\end{equation}
\startexplain
		\explain{$x_{ort}$ is the orthogonal point from the center point to $V_T$}{}
		\explain{$x_0$  is the previous point at the route}{}
		\explain{$V_T$ is the vector from the previous point to the next point on the route}{}
		\explain{$x_c$ is the center point of the vehicle}{}
\stopexplain
 
The reference point $x_{ref}$ can then be determined as:

\begin{equation}
x_{ref} = x_{ort} + \Delta t\cdot \vec{V_T} \addunit{}
\end{equation}

By this, the reference vector $\vec{V_{ref}}$ can be determined as:

\begin{equation}
\vec{V_{ref}} = \vec{x_c} - \vec{x_{ref}} \addunit{}
\end{equation}

By calculating the cross product between the direction vector $\vec{F}$ and the reference vector $\vec{V_{ref}}$, it can be determined whether the angle is different from $0$.

The difference between the angular velocities of the two motors can be determined as:

\begin{equation}
\omega_d = -K \cdot \frac{\vec{V_{ref}}\times \vec{F}}{|\vec{V_{ref}}|} \addunit{\SI{}{\radian/\second}}
\end{equation}

With this difference, the motor velocities can by a predefinition of the sum of the two motor velocities and the equations:

\begin{equation}
\omega_d = \omega_L - \omega_R \addunit{\radian\per\second}
\end{equation}
\begin{equation}
\omega_s = \omega_L + \omega_R \addunit{\radian\per\second}
\end{equation}
be determined as 
\begin{equation}
\omega_L = \frac{\omega_d}{2} + \frac{\omega_s}{2} \addunit{\radian\per\second}
\end{equation}
\begin{equation}
\omega_R = -\frac{\omega_d}{2} + \frac{\omega_s}{2} \addunit{\radian\per\second}
\end{equation}

\input{chapters/design/drivehandling/driving_simulation}
\input{chapters/design/drivehandling/driving_integration}


